# SQL Server Support

The Database Model Generator (formerly Oracle Model Generator) now supports both Oracle and Microsoft SQL Server databases, providing comprehensive ActiveRecord model generation with intelligent schema introspection and performance optimization recommendations.

## Overview

This tool automatically generates Rails ActiveRecord models from database schema with the following enhancements:

- **Dual Database Support**: Oracle and SQL Server
- **Schema Introspection**: Automatic table analysis
- **Performance Optimization**: Index recommendations
- **Test Generation**: RSpec, TestUnit, and Minitest support
- **Advanced Features**: Relationships, validations, scopes, enums, and callbacks

## Installation

### Prerequisites

```bash
# For Oracle support
gem install oci8

# For SQL Server support
gem install tiny_tds

# Core dependencies
gem install getopt
```

### SQL Server Requirements

- **Supported Versions**: SQL Server 2012, 2014, 2016, 2017, 2019, 2022
- **Connection**: Uses TinyTDS for native connectivity
- **Schema Access**: Requires read access to INFORMATION_SCHEMA views
- **Authentication**: Supports SQL Server Authentication and Windows Authentication

## Usage

### Basic Command Structure

```bash
# Explicit database type specification
./bin/omg -T <type> [connection_options] -t <table> [other_options]

# Auto-detection based on connection parameters
./bin/omg [connection_options] -t <table> [other_options]
```

### SQL Server Examples

#### Basic Model Generation
```bash
# Generate Employee model from SQL Server
./bin/omg -T sqlserver -s localhost -P 1433 -d northwind -u sa -p password -t Employees

# Auto-detect SQL Server (when server specified)
./bin/omg -s myserver -d adventureworks -u user -p pass -t Customers
```

#### Index Recommendations Only
```bash
# Show only performance recommendations
./bin/omg -T sqlserver -s localhost -d mydb -u user -p pass -t Orders --indexes
```

#### With Custom Options
```bash
# Generate with specific Rails version and test framework
./bin/omg -T sqlserver -s localhost -d mydb -u user -p pass -t Products -r 7 -x rspec -o product.rb
```

### Oracle Examples (Backward Compatible)

```bash
# Traditional Oracle connection
./bin/omg -T oracle -d localhost:1521/XE -u hr -p hr -t employees

# Auto-detect Oracle (no server specified)
./bin/omg -d localhost:1521/XE -u scott -p tiger -t users
```

## Connection Parameters

### SQL Server Connection Options

| Option | Short | Required | Description | Default |
|--------|--------|----------|-------------|---------|
| `--type` | `-T` | No | Database type (`sqlserver`) | Auto-detect |
| `--server` | `-s` | Yes* | SQL Server hostname | `localhost` |
| `--port` | `-P` | No | SQL Server port | `1433` |
| `--database` | `-d` | Yes | Database name | - |
| `--user` | `-u` | Yes | Username | - |
| `--password` | `-p` | Yes | Password | - |

*Required for SQL Server, triggers auto-detection

### Oracle Connection Options

| Option | Short | Required | Description | Default |
|--------|--------|----------|-------------|---------|
| `--type` | `-T` | No | Database type (`oracle`) | Auto-detect |
| `--database` | `-d` | Yes | TNS name or connection string | - |
| `--user` | `-u` | Yes | Username | - |
| `--password` | `-p` | Yes | Password | - |

## Generated Models

### SQL Server Model Example

```ruby
# Generated by Database Model Generator v0.6.0
# Database: SQL Server
# Table: Employees
# Generated on: 2024-12-19 15:30:00

class Employee < ActiveRecord::Base
  set_table_name "Employees"
  set_primary_key :EmployeeID

  # Recommended Indexes (add these to your database migration):
  # add_index :employees, :DepartmentID  # Foreign key index
  # add_index :employees, :ManagerID     # Foreign key index
  # add_index :employees, :Email, unique: true  # Unique constraint
  # add_index :employees, :HireDate      # Date queries
  # add_index :employees, [:DepartmentID, :HireDate]  # Composite index

  # Relationships
  belongs_to :department, foreign_key: :DepartmentID
  belongs_to :manager, class_name: 'Employee', foreign_key: :ManagerID, optional: true
  has_many :subordinates, class_name: 'Employee', foreign_key: :ManagerID

  # Scopes
  scope :active, -> { where(Status: 'Active') }
  scope :recent_hires, -> { where('HireDate > ?', 30.days.ago) }
  scope :by_department, ->(dept) { where(DepartmentID: dept) }

  # Validations
  validates :FirstName, presence: true, length: { maximum: 50 }
  validates :LastName, presence: true, length: { maximum: 50 }
  validates :Email, presence: true, uniqueness: true, length: { maximum: 100 }
  validates :HireDate, presence: true
  validates :Salary, numericality: { greater_than: 0 }, allow_nil: true

  # Enums
  enum Status: { active: 0, inactive: 1, terminated: 2 }

  # Class Methods
  def self.search(query)
    return all if query.blank?
    where("FirstName LIKE ? OR LastName LIKE ? OR Email LIKE ?", "%#{query}%", "%#{query}%", "%#{query}%")
  end

  def self.by_name
    order(:FirstName, :LastName)
  end

  # Instance Methods
  def full_name
    "#{FirstName} #{LastName}".strip
  end

  def display_name
    full_name.presence || "Employee #{EmployeeID}"
  end
end
```

## Database-Specific Features

### SQL Server Features

#### Schema Introspection
- Uses `INFORMATION_SCHEMA` views for portability
- Supports case-sensitive table and column names
- Detects SQL Server data types (`varchar`, `nvarchar`, `datetime2`, etc.)

#### Data Type Mapping
| SQL Server Type | ActiveRecord Validation | Ruby Type |
|----------------|------------------------|-----------|
| `varchar(n)` | `length: { maximum: n }` | String |
| `nvarchar(n)` | `length: { maximum: n }` | String |
| `int` | `numericality: { only_integer: true }` | Integer |
| `decimal(p,s)` | `numericality: { ... }` | BigDecimal |
| `datetime2` | `validates_date` | DateTime |
| `bit` | Boolean validation | Boolean |

#### Full-Text Search
```sql
-- SQL Server Full-Text Index
CREATE FULLTEXT INDEX ON Employees (FirstName, LastName)
KEY INDEX PK_Employees
```

### Oracle Features

#### Schema Introspection
- Uses `USER_*` dictionary views
- Traditional Oracle naming conventions
- Supports Oracle-specific data types (`VARCHAR2`, `NUMBER`, `DATE`)

#### Data Type Mapping
| Oracle Type | ActiveRecord Validation | Ruby Type |
|------------|------------------------|-----------|
| `VARCHAR2(n)` | `length: { maximum: n }` | String |
| `NUMBER(p,s)` | `numericality: { ... }` | Numeric |
| `DATE` | `validates_date` | Date |
| `CLOB` | Text validation | String |

#### Full-Text Search
```sql
-- Oracle Text Index
CREATE INDEX idx_employees_name_text ON EMPLOYEES (FIRST_NAME)
INDEXTYPE IS CTXSYS.CONTEXT
```

## Performance Optimization

### Index Recommendations

The generator analyzes your schema and suggests performance-optimizing indexes:

#### 1. Foreign Key Indexes
```ruby
# Detected relationships automatically get index recommendations
add_index :orders, :customer_id       # Speeds up JOINs
add_index :order_items, :product_id   # Foreign key performance
```

#### 2. Unique Constraint Indexes
```ruby
# Email, username, and code fields get unique indexes
add_index :users, :email, unique: true
add_index :products, :sku, unique: true
```

#### 3. Date Query Indexes
```ruby
# Date/timestamp columns get indexes for range queries
add_index :orders, :created_at
add_index :events, :start_date
```

#### 4. Composite Indexes
```ruby
# Multi-column indexes for common query patterns
add_index :orders, [:customer_id, :created_at]
add_index :tasks, [:status, :due_date]
```

### Performance Impact

| Index Type | Performance Gain | Use Case |
|------------|------------------|----------|
| Foreign Key | 10-100x | JOIN operations |
| Unique | Instant validation | Uniqueness checks |
| Date | 5-50x | Date range queries |
| Composite | 2-100x | Multi-column WHERE |
| Full-Text | Search enabled | Text search |

## Migration Generation

### Rails Migration Example

The `--indexes` option generates ready-to-use Rails migrations:

```ruby
class AddIndexesToEmployees < ActiveRecord::Migration[7.0]
  def change
    # Foreign key indexes
    add_index :employees, :DepartmentID
    add_index :employees, :ManagerID

    # Unique constraints
    add_index :employees, :Email, unique: true

    # Date optimization
    add_index :employees, :HireDate

    # Composite indexes for common queries
    add_index :employees, [:DepartmentID, :HireDate]

    # Full-text search (database-specific)
    case connection.adapter_name
    when 'SQLServer'
      execute "CREATE FULLTEXT INDEX ON Employees (FirstName, LastName) KEY INDEX PK_Employees"
    when 'Oracle', 'OracleEnhanced'
      execute "CREATE INDEX idx_employees_name_text ON EMPLOYEES (FIRST_NAME) INDEXTYPE IS CTXSYS.CONTEXT"
    end
  end
end
```

## Advanced Usage

### Environment-Specific Configuration

```ruby
# config/database.yml
development:
  adapter: sqlserver  # or oracle_enhanced
  host: localhost
  port: 1433
  database: myapp_dev
  username: dev_user
  password: dev_pass

production:
  adapter: sqlserver
  host: <%= ENV['DB_HOST'] %>
  port: <%= ENV['DB_PORT'] || 1433 %>
  database: <%= ENV['DB_NAME'] %>
  username: <%= ENV['DB_USER'] %>
  password: <%= ENV['DB_PASS'] %>
```

### Batch Model Generation

```bash
# Generate models for multiple tables
for table in Customers Orders Products; do
  ./bin/omg -T sqlserver -s myserver -d mydb -u user -p pass -t $table
done

# Generate only index recommendations for all tables
for table in $(sqlcmd -Q "SELECT TABLE_NAME FROM INFORMATION_SCHEMA.TABLES" -h-1); do
  ./bin/omg -T sqlserver -s myserver -d mydb -u user -p pass -t $table --indexes
done
```

### Integration with Rails

```ruby
# lib/tasks/db_models.rake
namespace :db do
  desc "Generate models from database schema"
  task :generate_models => :environment do
    config = Rails.application.config.database_configuration[Rails.env]

    case config['adapter']
    when 'sqlserver'
      system("./bin/omg -T sqlserver -s #{config['host']} -d #{config['database']} -u #{config['username']} -p #{config['password']} -t #{ENV['TABLE']}")
    when 'oracle_enhanced'
      system("./bin/omg -T oracle -d #{config['database']} -u #{config['username']} -p #{config['password']} -t #{ENV['TABLE']}")
    end
  end
end

# Usage: rails db:generate_models TABLE=employees
```

## Troubleshooting

### Common Issues

#### SQL Server Connection
```bash
# Connection timeout
./bin/omg -T sqlserver -s myserver -d mydb -u user -p pass -t mytable
# Error: TLS/SSL connection failed

# Solution: Disable encryption for development
TinyTds::Client.new(
  host: 'myserver',
  username: 'user',
  password: 'pass',
  database: 'mydb',
  encrypt: false
)
```

#### Missing Dependencies
```bash
# Install SQL Server support
gem install tiny_tds

# On Ubuntu/Debian
sudo apt-get install freetds-dev

# On macOS
brew install freetds
```

#### Permission Issues
```sql
-- Grant necessary permissions
GRANT SELECT ON INFORMATION_SCHEMA.TABLES TO [username];
GRANT SELECT ON INFORMATION_SCHEMA.COLUMNS TO [username];
GRANT SELECT ON INFORMATION_SCHEMA.TABLE_CONSTRAINTS TO [username];
```

### Debugging

Enable verbose output:
```bash
# Set environment variable for debugging
DEBUG=1 ./bin/omg -T sqlserver -s myserver -d mydb -u user -p pass -t mytable
```

## Migration from Oracle-Only Version

### Backward Compatibility

The tool maintains full backward compatibility:

```ruby
# Old code still works
require 'oracle/model/generator'
connection = OCI8.new(user, pass, database)
omg = Oracle::Model::Generator.new(connection)

# New code provides more features
require 'database_model_generator'
omg = DatabaseModel::Generator.new(connection, type: :oracle)
```

### Upgrading Existing Projects

1. **Install new dependencies**:
   ```bash
   gem install tiny_tds  # For SQL Server support
   ```

2. **Update require statements**:
   ```ruby
   # From
   require 'oracle/model/generator'

   # To
   require 'database_model_generator'
   ```

3. **Use new CLI options**:
   ```bash
   # Old Oracle-specific
   ./bin/omg -d oracle_db -u user -p pass -t table

   # New database-agnostic
   ./bin/omg -T oracle -d oracle_db -u user -p pass -t table
   ./bin/omg -T sqlserver -s sql_server -d sql_db -u user -p pass -t table
   ```

## Contributing

### Adding Database Support

To add support for additional databases (PostgreSQL, MySQL, etc.):

1. **Create database-specific generator**:
   ```ruby
   # lib/postgresql_generator.rb
   class PostgresqlGenerator < DatabaseModel::Generator::Base
     # Implement abstract methods
   end
   ```

2. **Add connection detection**:
   ```ruby
   # lib/database_model_generator.rb
   def self.detect_database_type(connection, options = {})
     case connection.class.name
     when 'PG::Connection'
       :postgresql
     # ... existing cases
     end
   end
   ```

3. **Update CLI support**:
   ```ruby
   # bin/omg - add new connection logic
   ```

The modular architecture makes adding new database support straightforward while maintaining existing functionality.

## License

This tool maintains the same license as the original Oracle Model Generator. SQL Server support is provided under the same terms.
